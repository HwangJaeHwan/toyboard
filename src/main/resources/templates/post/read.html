<!DOCTYPE html>
<html lang="en" th:replace="~{layout/base :: layout(~{::content})}" xmlns:th="http://www.thymeleaf.org">


<div class="flex-box justify-content-center" th:fragment="content">

    <div class="flex-c w80">

        <h3>[[${post.title}]]</h3>
        <br>

        <div class="flex-box justify-content-end">
            <span th:text="${post.nickname}" ></span>
        </div>

        <div class="flex-box justify-content-end">
            <span th:text="${post.getCreateTime()}"></span>
            조회수 : <span th:text="${post.hits}"></span>
            추천 :<span th:text="${post.recommendedNumber}"></span>
        </div>
        <div class="flex-box justify-content-end" th:if="${session.loginUser.equals(post.nickname)}">
            <a th:href="@{/post/update/{id}(id = ${post.id})}" class="btn btn-primary">수정</a>
        </div>


        <div class="form-group">

            <textarea class="col-md-12" th:text="${post.content}" readonly>

            </textarea>

        </div>
        <h2 id="commentNums" >댓글 [[${commentNums}]]개</h2>
        <div id="test">

        </div>
    <div id="comments">
        <div th:id="|comment${commentDTO.id}|" th:class="flex-c" th:each="commentDTO : ${comments}">

            <div  class="flex-box justify-content-space-between">
                <span th:text="${commentDTO.nickname}">닉네임</span>
                <div>
                <button th:if="${session.loginUser.equals(commentDTO.nickname)}" th:onclick="|clickDelete(${commentDTO.id},${commentNums})|" >삭제하기</button>
                <button th:unless="${session.loginUser.equals(commentDTO.nickname)}" th:onclick="|clickReport(${commentDTO.id})|">신고하기</button>

                </div>
            </div>

            <div>
                <p th:if="${commentDTO.report >= 10}">블라인드 처리된 댓글입니다.</p>
                <textarea class="col-md-12 h-100" th:id="|commentContent${commentDTO.id}|" th:if="${commentDTO.report < 10}" th:text="${commentDTO.content}" readonly></textarea>
            </div>


            <div class="flex-box justify-content-end margin-bottom-30">
                <button th:onclick="|commentUp(${commentDTO.id})|">up</button>
                <span th:id="|up${commentDTO.id}|" th:text="${commentDTO.up}"></span>
                <button th:onclick="|commentDown(${commentDTO.id})|">down</button>
                <span th:id="|down${commentDTO.id}|" th:text="${commentDTO.down}"></span>
            </div>

        </div>
    </div>

        <div>
            <h3>댓글 작성</h3>

            <div class="flex-box">
                <textarea id="newComment" class="col-md-11 h-100" placeholder="댓글을 입력해주세요."></textarea>
                <button class="col-md-1 h-100" th:onclick="|addComment(${post.id})|">작성</button>
            </div>


        </div>


    </div>


    <script th:inline="javascript">

        let postId = [[${post.id}]];


        function showComments(id){

            const session = [[${session.loginUser}]];
            let commentNums;

            $.ajax({
                url: "/comment/" + id,
                type: "GET",

                success: function (data) {
                    commentNums = data.length;

                    $("#comments").empty();

                    console.log(data)
                    data.forEach(function (commentDTO) {

                        document.getElementById("comments").innerHTML += '<div id="comment' + commentDTO.id + '"class="flex-c">\n' +
                            '<div  id="commentHead'+commentDTO.id+'" class="flex-box justify-content-space-between">\n' +
                            '<span>' + commentDTO.nickname + '</span>';


                                if (session === commentDTO.nickname) {
                                    document.getElementById("commentHead"+commentDTO.id).innerHTML += '<div> <button onclick="clickDelete(' + commentDTO.id + ')">삭제하기</button> </div>';
                                } else {
                                    document.getElementById("commentHead"+commentDTO.id).innerHTML += '<div> <button onclick="clickReport(' + commentDTO.id + ')">신고하기</button> </div>';
                                }




                            if (commentDTO.report >= 10) {
                                document.getElementById("comment"+commentDTO.id).innerHTML += '<p>블라인드 처리된 댓글입니다.</p>';
                            } else {
                                document.getElementById("comment"+commentDTO.id).innerHTML += '<div><textarea class="col-md-12 h-100" id="commentContent' + commentDTO.id + '" readonly>' + commentDTO.content + '</textarea> </div>'
                            }



                            document.getElementById("comment"+commentDTO.id).innerHTML += ' <div class="flex-box justify-content-end margin-bottom-30">\n' +
                                '                <button onclick="commentUp(' + commentDTO.id + ')">up</button>\n' +
                                '                <span id="up' + commentDTO.id + '">'+commentDTO.up+'</span>\n' +
                                '                <button onclick="commentDown(' + commentDTO.id + ')">down</button>\n' +
                                '                <span id="down' + commentDTO.id + '">'+commentDTO.down+'</span>\n' +
                                '            </div>';



                        }
                    );

                    $("#commentNums").html("댓글 " + commentNums + "개");
                }

            });



        }


        function clickReport(id){


            if (!confirm("해당 댓글을 신고하시겠습니까?")) {
                return;
            }


            $.ajax({
                url: "/comment/report/" + id,
                type: "PATCH",


                success: function (data){
                    alert(data);
                }
            })


        }

        function addComment(id){

             let content = document.getElementById("newComment").value;

            let comment = new Object();

            console.log(content)

            if (content.length == 0) {
                alert("댓글을 입력해주세요");
                return;
            }

            comment.content = content;

            console.log(JSON.stringify(comment));

            $.ajax({
                url: "/comment/" + id,
                type: "POST",
                data: JSON.stringify(comment),
                contentType: "application/json; charset=uft-8",

                success: function (data) {
                    console.log(data);
                    showComments(id);
                    document.getElementById("newComment").value = null;

                }

            })

        }

        function clickDelete(id) {

            if (!confirm("해당 댓글을 삭제하시겠습니까?")) {
                return;
            }


            console.log(id);

            $.ajax({
                url: "/comment/" + id,
                type: "DELETE",


                success: function (data){
                    alert(data);
                    showComments(postId)
                }
            })



        }

        function commentUp(id){

            $.ajax({
                url: "/comment/upButton/" + id,
                type: "GET",

                success: function (data){
                    console.log(data);
                    if (data.dup) {
                        alert("이미 down을 누른 댓글입니다.");
                        return;
                    }

                    document.getElementById("up" + id).innerHTML = "<span>" + data.upCount + "</span>";
                }


            })


        }

        function commentDown(id){

            $.ajax({
                url: "/comment/downButton/" + id,
                type: "GET",

                success: function (data){
                    console.log(data);

                    if (data.dup) {
                        alert("이미 up을 누른 댓글입니다.");
                        return;
                    }

                    document.getElementById("down" + id).innerHTML = "<span>" + data.downCount + "</span>";
                }


            })


        }






    </script>



</div>






</html>